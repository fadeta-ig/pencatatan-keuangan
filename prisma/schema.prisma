// Prisma Schema - Pencatatan Keuangan
// Database: PostgreSQL
// ORM: Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum AccountType {
  BANK
  CASH
  E_WALLET
  INVESTMENT
  CREDIT_CARD
  OTHER
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum CategoryType {
  INCOME
  EXPENSE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

// ============================================
// MODELS
// ============================================

/// User model for authentication and profile
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String   // Will be hashed

  // User preferences
  timezone  String   @default("Asia/Jakarta")
  currency  String   @default("IDR")
  locale    String   @default("id-ID")

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  accounts     Account[]
  categories   Category[]
  transactions Transaction[]
  transfers    Transfer[]
  tags         Tag[]
  auditLogs    AuditLog[]

  @@index([email])
  @@map("users")
}

/// Account model for managing different financial accounts
model Account {
  id             String      @id @default(cuid())
  userId         String
  name           String
  type           AccountType @default(BANK)
  currency       String      @default("IDR")
  initialBalance Decimal     @default(0) @db.Decimal(19, 2)
  description    String?
  color          String?     @default("#3B82F6")
  isActive       Boolean     @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions        Transaction[]
  transfersFrom       Transfer[]    @relation("TransferFrom")
  transfersTo         Transfer[]    @relation("TransferTo")

  @@index([userId])
  @@index([userId, isActive])
  @@map("accounts")
}

/// Category model for organizing transactions
model Category {
  id          String       @id @default(cuid())
  userId      String
  name        String
  type        CategoryType
  description String?
  color       String       @default("#6366F1")
  icon        String?
  isActive    Boolean      @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([userId, name, type])
  @@index([userId, type])
  @@index([userId, isActive])
  @@map("categories")
}

/// Transaction model for income and expense records
model Transaction {
  id         String          @id @default(cuid())
  userId     String
  accountId  String
  categoryId String?

  type       TransactionType
  amount     Decimal         @db.Decimal(19, 2)
  currency   String          @default("IDR")
  date       DateTime        @default(now())
  notes      String?

  // Additional metadata
  attachmentUrl  String?
  attachmentMeta Json?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  Account           @relation(fields: [accountId], references: [id], onDelete: Restrict)
  category Category?         @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags     TransactionTag[]

  @@index([userId])
  @@index([userId, date])
  @@index([userId, accountId])
  @@index([userId, categoryId])
  @@index([userId, type])
  @@index([userId, date, type])
  @@map("transactions")
}

/// Transfer model for money transfers between accounts
model Transfer {
  id            String   @id @default(cuid())
  userId        String
  fromAccountId String
  toAccountId   String

  amount        Decimal  @db.Decimal(19, 2)
  currency      String   @default("IDR")
  date          DateTime @default(now())
  notes         String?

  // Exchange rate for multi-currency transfers
  exchangeRate  Decimal? @db.Decimal(19, 6)
  convertedAmount Decimal? @db.Decimal(19, 2)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  fromAccount Account @relation("TransferFrom", fields: [fromAccountId], references: [id], onDelete: Restrict)
  toAccount   Account @relation("TransferTo", fields: [toAccountId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([userId, date])
  @@index([userId, fromAccountId])
  @@index([userId, toAccountId])
  @@map("transfers")
}

/// Tag model for flexible transaction labeling
model Tag {
  id          String   @id @default(cuid())
  userId      String
  name        String
  color       String   @default("#8B5CF6")
  description String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions TransactionTag[]

  @@unique([userId, name])
  @@index([userId])
  @@map("tags")
}

/// Junction table for many-to-many relationship between Transaction and Tag
model TransactionTag {
  transactionId String
  tagId         String

  // Metadata
  createdAt DateTime @default(now())

  // Relations
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  tag         Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([transactionId, tagId])
  @@index([transactionId])
  @@index([tagId])
  @@map("transaction_tags")
}

/// Audit log for tracking changes to critical data
model AuditLog {
  id        String      @id @default(cuid())
  userId    String
  action    AuditAction
  entity    String      // Table/Model name
  entityId  String      // ID of the affected record

  // JSON diff of changes
  oldData   Json?
  newData   Json?

  // Additional context
  ipAddress String?
  userAgent String?

  // Metadata
  timestamp DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entity, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}
